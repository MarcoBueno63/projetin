import React, { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import './MenuPrincipal.css';

const MenuPrincipal = () => {
  const navigate = useNavigate();
  
  const [dadosUsuario, setDadosUsuario] = useState(null);
  const [menuAtivo, setMenuAtivo] = useState('principal');

  useEffect(() => {
    // Verificar se usu√°rio est√° logado
    const usuario = JSON.parse(localStorage.getItem('usuario'));
    if (!usuario || !usuario.loggedIn) {
      navigate('/');
      return;
    }
    setDadosUsuario(usuario);
    
    // Definir menu ativo baseado no tipo de usu√°rio
    if (usuario.tipo === 'admin') {
      setMenuAtivo('admin');
    } else {
      setMenuAtivo('principal');
    }
  }, [navigate]);

  // Filtrar funcionalidades baseadas nas permiss√µes do usu√°rio
  const getFuncionalidadesPermitidas = (funcionalidades) => {
    if (!dadosUsuario || !dadosUsuario.permissoes) return [];
    
    return funcionalidades.filter(func => 
      dadosUsuario.permissoes.some(permissao => 
        func.permissoes.includes(permissao)
      )
    );
  };

  const funcionalidadesPrincipais = [
    {
      id: 'anamnese',
      titulo: 'Anamnese Integrativa',
      descricao: 'Preencher question√°rio completo de sa√∫de',
      icone: 'üìã',
      rota: '/anamnese-integrativa',
      cor: '#4CAF50',
      permissoes: ['usuario', 'medico', 'admin'],
      ordem: 1,
      status: 'disponivel'
    },
    {
      id: 'exames',
      titulo: 'Importar Exames',
      descricao: 'Fazer upload de exames m√©dicos',
      icone: 'üìä',
      rota: '/exames',
      cor: '#2196F3',
      permissoes: ['usuario', 'medico', 'admin'],
      ordem: 2,
      status: 'disponivel'
    },
    {
      id: 'analise-ia',
      titulo: 'An√°lise IA',
      descricao: 'Solicitar an√°lise inteligente dos dados',
      icone: 'ü§ñ',
      rota: '/ia-analise',
      cor: '#FF9800',
      permissoes: ['usuario', 'medico', 'admin'],
      ordem: 3,
      status: 'disponivel'
    },
    {
      id: 'relatorio',
      titulo: 'Relat√≥rio M√©dico',
      descricao: 'Gerar relat√≥rio completo da an√°lise',
      icone: 'üìã',
      rota: '/relatorio',
      cor: '#9C27B0',
      permissoes: ['usuario', 'medico', 'admin'],
      ordem: 4,
      status: 'disponivel'
    },
    {
      id: 'medico',
      titulo: 'Indica√ß√£o M√©dica',
      descricao: 'Encontrar m√©dico especialista',
      icone: 'üë®‚Äç‚öïÔ∏è',
      rota: '/medico',
      cor: '#009688',
      permissoes: ['usuario', 'medico', 'admin'],
      ordem: 5,
      status: 'disponivel'
    },
    {
      id: 'consulta',
      titulo: 'Agendar Consulta',
      descricao: 'Marcar consulta com especialista',
      icone: 'üìÖ',
      rota: '/agendar',
      cor: '#E91E63',
      permissoes: ['usuario', 'medico', 'admin'],
      ordem: 6,
      status: 'disponivel'
    },
    {
      id: 'historico',
      titulo: 'Hist√≥rico M√©dico',
      descricao: 'Visualizar hist√≥rico completo',
      icone: 'üìñ',
      rota: '/historico',
      cor: '#607D8B',
      permissoes: ['usuario', 'medico', 'admin'],
      ordem: 7,
      status: 'disponivel'
    },
    {
      id: 'medicamentos',
      titulo: 'Medicamentos',
      descricao: 'Gerenciar medicamentos e lembretes',
      icone: 'üíä',
      rota: '/medicamentos',
      cor: '#795548',
      permissoes: ['usuario', 'medico', 'admin'],
      ordem: 8,
      status: 'disponivel'
    }
  ];

  const menuMedico = [
    {
      id: 'consultas-medico',
      titulo: 'Minhas Consultas',
      descricao: 'Gerenciar agenda e consultas m√©dicas',
      icone: 'üìÖ',
      rota: '/medico/consultas',
      permissoes: ['medico', 'admin']
    },
    {
      id: 'pacientes-medico',
      titulo: 'Meus Pacientes',
      descricao: 'Visualizar e gerenciar pacientes',
      icone: 'üë•',
      rota: '/medico/pacientes',
      permissoes: ['medico', 'admin']
    },
    {
      id: 'prescricoes',
      titulo: 'Prescri√ß√µes',
      descricao: 'Criar e gerenciar prescri√ß√µes m√©dicas',
      icone: 'üìù',
      rota: '/medico/prescricoes',
      permissoes: ['medico', 'admin']
    },
    {
      id: 'laudos',
      titulo: 'Laudos M√©dicos',
      descricao: 'Elaborar laudos e pareceres',
      icone: 'üìã',
      rota: '/medico/laudos',
      permissoes: ['medico', 'admin']
    },
    {
      id: 'ia-diagnostico',
      titulo: 'IA para Diagn√≥stico',
      descricao: 'Assistente de IA para diagn√≥sticos',
      icone: 'ü§ñ',
      rota: '/medico/ia-diagnostico',
      permissoes: ['medico', 'admin']
    },
    {
      id: 'exames-medico',
      titulo: 'An√°lise de Exames',
      descricao: 'Revisar e analisar exames dos pacientes',
      icone: 'üî¨',
      rota: '/medico/exames',
      permissoes: ['medico', 'admin']
    },
    {
      id: 'relatorios-medico',
      titulo: 'Relat√≥rios M√©dicos',
      descricao: 'Gerar relat√≥rios de pacientes e estat√≠sticas',
      icone: 'üìä',
      rota: '/medico/relatorios',
      permissoes: ['medico', 'admin']
    },
    {
      id: 'telemedicina',
      titulo: 'Telemedicina',
      descricao: 'Consultas online e chat com pacientes',
      icone: 'üíª',
      rota: '/medico/telemedicina',
      permissoes: ['medico', 'admin']
    }
  ];

  const menuAdministrativo = [
    {
      id: 'admin-dashboard',
      titulo: 'Dashboard Admin',
      descricao: 'Painel administrativo principal',
      icone: 'üè†',
      rota: '/admin',
      permissoes: ['admin']
    },
    {
      id: 'cadastros',
      titulo: 'Cadastros',
      descricao: 'Gerenciar usu√°rios, m√©dicos e pacientes',
      icone: 'üë•',
      rota: '/admin/cadastros',
      permissoes: ['admin']
    },
    {
      id: 'estatisticas',
      titulo: 'Estat√≠sticas',
      descricao: 'Visualizar dados e m√©tricas do sistema',
      icone: 'üìä',
      rota: '/estatisticas',
      permissoes: ['admin']
    },
    {
      id: 'configuracoes',
      titulo: 'Configura√ß√µes',
      descricao: 'Configurar sistema e prefer√™ncias',
      icone: '‚öôÔ∏è',
      rota: '/configuracoes',
      permissoes: ['admin']
    },
    {
      id: 'usuarios',
      titulo: 'Gerenciar Usu√°rios',
      descricao: 'Adicionar, editar e remover usu√°rios',
      icone: 'üë§',
      rota: '/admin/usuarios',
      permissoes: ['admin']
    },
    {
      id: 'medicos',
      titulo: 'Gerenciar M√©dicos',
      descricao: 'Cadastrar e gerenciar m√©dicos',
      icone: 'üë®‚Äç‚öïÔ∏è',
      rota: '/admin/medicos',
      permissoes: ['admin']
    }
  ];

  const handleNavegacao = (rota) => {
    navigate(rota);
  };

  const handleLogout = () => {
    localStorage.removeItem('usuario');
    navigate('/');
  };

  const renderFuncionalidades = (funcionalidades, titulo) => {
    const funcionalidadesPermitidas = getFuncionalidadesPermitidas(funcionalidades);
    
    if (funcionalidadesPermitidas.length === 0) return null;

    // Ordenar funcionalidades por ordem (se existir)
    const funcionalidadesOrdenadas = funcionalidadesPermitidas.sort((a, b) => {
      if (a.ordem && b.ordem) {
        return a.ordem - b.ordem;
      }
      return 0;
    });
    
    return (
      <div className="funcionalidades-section">
        <h2>{titulo}</h2>
        <div className="funcionalidades-grid">
          {funcionalidadesOrdenadas.map((func) => (
            <div
              key={func.id}
              className={`funcionalidade-card ${func.status || 'disponivel'}`}
              onClick={() => handleNavegacao(func.rota)}
              style={{ '--cor-destaque': func.cor }}
            >
              {func.ordem && (
                <div className="funcionalidade-ordem">
                  <span className="ordem-numero">{func.ordem}</span>
                </div>
              )}
              <div className="funcionalidade-icon">{func.icone}</div>
              <div className="funcionalidade-info">
                <h3>{func.titulo}</h3>
                <p>{func.descricao}</p>
                {func.status && (
                  <div className={`status-indicator ${func.status}`}>
                    {func.status === 'disponivel' && '‚úÖ Dispon√≠vel'}
                    {func.status === 'em-breve' && '‚è≥ Em breve'}
                    {func.status === 'beta' && 'üß™ Beta'}
                    {func.status === 'desenvolvimento' && 'üîß Em desenvolvimento'}
                  </div>
                )}
              </div>
              <div className="funcionalidade-arrow">‚Üí</div>
            </div>
          ))}
        </div>
      </div>
    );
  };

  const getUserTypeDisplay = (tipo) => {
    switch(tipo) {
      case 'admin': return 'üë®‚Äçüíº Administrador';
      case 'medico': return 'üë®‚Äç‚öïÔ∏è M√©dico';
      case 'usuario': return 'üë§ Usu√°rio';
      default: return 'üë§ Usu√°rio';
    }
  };

  const shouldShowTab = (tab) => {
    if (!dadosUsuario) return false;
    
    if (tab === 'admin') {
      return dadosUsuario.permissoes.includes('admin');
    }
    
    if (tab === 'medico') {
      return dadosUsuario.permissoes.includes('medico');
    }
    
    return true; // tab principal sempre vis√≠vel
  };

  if (!dadosUsuario) {
    return (
      <div className="loading-container">
        <div className="loading-spinner"></div>
        <p>Carregando...</p>
      </div>
    );
  }

  return (
    <div className="menu-principal">
      <div className="menu-header">
        <div className="user-info">
          <div className="user-avatar">
            {dadosUsuario.nome?.charAt(0).toUpperCase() || 'U'}
          </div>
          <div className="user-details">
            <h1>Ol√°, {dadosUsuario.nome || 'Usu√°rio'}!</h1>
            <p>{getUserTypeDisplay(dadosUsuario.tipo)}</p>
            <small>Bem-vindo ao HealthSystem</small>
          </div>
        </div>
        <div className="menu-actions">
          <button 
            className={`menu-tab ${menuAtivo === 'principal' ? 'active' : ''}`}
            onClick={() => setMenuAtivo('principal')}
          >
            üìã Funcionalidades
          </button>
          
          {shouldShowTab('medico') && (
            <button 
              className={`menu-tab ${menuAtivo === 'medico' ? 'active' : ''}`}
              onClick={() => setMenuAtivo('medico')}
            >
              üë®‚Äç‚öïÔ∏è M√©dico
            </button>
          )}
          
          {shouldShowTab('admin') && (
            <button 
              className={`menu-tab ${menuAtivo === 'admin' ? 'active' : ''}`}
              onClick={() => setMenuAtivo('admin')}
            >
              üë®‚Äçüíº Administrativo
            </button>
          )}
          
          <button className="logout-btn" onClick={handleLogout}>
            üö™ Sair
          </button>
        </div>
      </div>

      <div className="menu-content">
        {menuAtivo === 'principal' && renderFuncionalidades(funcionalidadesPrincipais, 'Funcionalidades Principais')}
        {menuAtivo === 'medico' && renderFuncionalidades(menuMedico, '√Årea M√©dica')}
        {menuAtivo === 'admin' && renderFuncionalidades(menuAdministrativo, '√Årea Administrativa')}
      </div>

      <div className="menu-footer">
        <p>¬© 2025 HealthSystem - Sistema de Gest√£o de Sa√∫de</p>
        <div className="footer-links">
          <a href="/ajuda">Ajuda</a>
          <a href="/suporte">Suporte</a>
          <a href="/sobre">Sobre</a>
        </div>
      </div>
    </div>
  );
};

export default MenuPrincipal;
